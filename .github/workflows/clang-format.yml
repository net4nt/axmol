name: clang-format

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      lint_mode:
        description: 'Select lint mode: check_only, auto_commit, or create_pr'
        required: true
        default: 'check_only'
        type: choice
        options:
          - check_only
          - create_pr
          - auto_commit
  issue_comment:
    types: [created] # Listen for new comments on issues/PRs

env:
  LINT_MODE: "${{ inputs.lint_mode || 'check_only' }}"

jobs:
  clang-format-lint:
    runs-on: ubuntu-latest
    # Run if:
    # - PR event
    # - workflow_dispatch
    # - issue_comment on a PR with /clang-format AND commenter is halx99
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request != null &&
       startsWith(github.event.comment.body, '/clang-format') &&
       contains(fromJSON('["halx99"]'), github.event.comment.user.login))

    steps:
    # Reply start message when triggered by comment
    - name: Reply start message
      if: github.event_name == 'issue_comment'
      uses: peter-evans/create-or-update-comment@v4
      with:
        token: ${{ secrets.AX_BOT_TOKEN || github.token }}
        issue-number: ${{ github.event.issue.number }}
        body: |
          üëã @${{ github.event.comment.user.login }} Command **/clang-format** received. Running code formatting, please wait...

    # Get PR info when triggered by a comment
    - name: Get PR info (for comment trigger)
      if: github.event_name == 'issue_comment'
      id: pr
      uses: actions-ecosystem/action-get-merged-pull-request@v1
      with:
        github_token: ${{ secrets.AX_BOT_TOKEN || github.token }}
        number: ${{ github.event.issue.number }}

    # Checkout correct branch
    - uses: actions/checkout@v5
      with:
        ref: ${{ github.event_name == 'issue_comment' && steps.pr.outputs.head_ref || github.head_ref || github.ref_name }}
        repository: ${{ github.event_name == 'issue_comment' && steps.pr.outputs.head_repo || github.repository }}
        token: ${{ secrets.AX_BOT_TOKEN || github.token }}

    # Override LINT_MODE to auto_commit if triggered by /clang-format comment and store head commit hash
    - name: Prepare clang-format lint
      shell: pwsh
      run: |
        if ($env:GITHUB_EVENT_NAME -eq 'issue_comment') {
          $env:LINT_MODE = 'auto_commit'
          echo "LINT_MODE=$env:LINT_MODE" >> $GITHUB_ENV
        }
        $env:HEAD_COMMIT_HASH = $(git rev-parse --short HEAD)
        echo "HEAD_COMMIT_HASH=$env:HEAD_COMMIT_HASH" >> $GITHUB_ENV
        echo "env.LINT_MODE=$env:LINT_MODE"
        echo "env.HEAD_COMMIT_HASH=$env:HEAD_COMMIT_HASH"

    - name: Run clang-format lint
      uses: DoozyX/clang-format-lint-action@v0.20
      with:
        source: './axmol ./extensions ./tests ./templates'
        exclude: './3rdparty ./extensions/ImGui/**/im* ./extensions/fairygui ./extensions/Live2D ./extensions/Effekseer ./extensions/scripting/lua-bindings/auto ./extensions/spine ./tests/cpp-tests/Source/Box2DTestBed/samples ./tests/fairygui-tests ./tests/live2d-tests ./extensions/**/*_generated.h'
        extensions: 'h,cpp,c,mm'
        clangFormatVersion: 20
        inplace: True

    # check_only mode
    - name: Check for uncommitted changes
      if: ${{ env.LINT_MODE == 'check_only' }}
      shell: pwsh
      run: |
        git diff --quiet
        if ($LASTEXITCODE -ne 0) {
          Write-Host "‚ùå clang-format check failed: Uncommitted formatting changes detected."
          Write-Host "=== The following differences require formatting ==="
          git --no-pager diff
          Write-Host "===================================================="
          exit 1
        }
        else {
          Write-Host "‚úÖ clang-format check passed: No formatting changes needed."
        }

    # create_pr mode
    - name: Create pull request
      if: ${{ env.LINT_MODE == 'create_pr' }}
      id: cpr
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.AX_BOT_TOKEN || github.token }}
        push-to-fork: axmol-bot/axmol
        commit-message: Committing clang-format changes
        signoff: false
        branch: clang_format_for_${{ env.HEAD_COMMIT_HASH }}
        delete-branch: true
        title: 'Committing clang-format changes ${{ env.HEAD_COMMIT_HASH }}'
        body: |
          RT
          - Auto-generated by [create-pull-request][1]

          [1]: https://github.com/peter-evans/create-pull-request
        labels: |
          clang-format
          automated pr
          pinned
        assignees: axmol-bot
        reviewers: halx99
        draft: false

    - name: Check pull request outputs
      if: ${{ env.LINT_MODE == 'create_pr' && steps.cpr.outputs.pull-request-number }}
      run: |
        echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
        echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"

    # auto_commit mode (including comment trigger)
    - name: Commit clang-format changes to PR source branch
      if: ${{ env.LINT_MODE == 'auto_commit' }}
      uses: EndBug/add-and-commit@v9
      with:
        author_name: axmol-bot
        author_email: 116471739+axmol-bot@users.noreply.github.com
        committer_name: GitHub Actions
        committer_email: 41898282+github-actions[bot]@users.noreply.github.com
        message: 'Committing clang-format changes'
        new_branch: ${{ github.head_ref || github.ref_name || steps.pr.outputs.head_ref }}
      env:
        GITHUB_TOKEN: ${{ secrets.AX_BOT_TOKEN || github.token }}

    # Reply finish message after auto_commit success
    - name: Reply finish message
      if: ${{ success() && env.LINT_MODE == 'auto_commit' && github.event_name == 'issue_comment' }}
      uses: peter-evans/create-or-update-comment@v4
      with:
        token: ${{ secrets.AX_BOT_TOKEN || github.token }}
        issue-number: ${{ github.event.issue.number }}
        body: |
          ‚úÖ Formatting completed and changes have been committed to the PR branch.
          @${{ github.event.comment.user.login }} please refresh to see the latest code.

    # Reply failure message if job fails
    - name: Reply failure message
      if: ${{ failure() && github.event_name == 'issue_comment' }}
      uses: peter-evans/create-or-update-comment@v4
      with:
        token: ${{ secrets.AX_BOT_TOKEN || github.token }}
        issue-number: ${{ github.event.issue.number }}
        body: |
          ‚ùå Formatting failed. Please check the GitHub Actions logs for details.
